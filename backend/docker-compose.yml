version: "3.8"

services:
  auth:
#    build:
#      context: ./
#      dockerfile: ./Auth.Dockerfile
    image: auth
    command:
      - "-mongoURI"
      - "mongodb://db:27017/?replicaSet=rs0"
      - "-redisAddress"
      - "cache:6379"
    ports:
      - target: 4000
        published: 4000
  cardsets:
#    build:
#      context: ./
#      dockerfile: ./CardSets.Dockerfile
    image: cardsets
    command:
      - "-mongoURI"
      - "mongodb://db:27017/?replicaSet=rs0"
      - "-redisAddress"
      - "cache:6379"
    ports:
      - target: 4001
        published: 4001
  cache:
    image: redis:6.2-alpine
    restart: always
    ports:
      - '6379:6379'
    command: redis-server 
    volumes:
      - testdb:/sth/to/test1

  db:
    image: mongo:5
    command: --replSet rs0
    ports:
      - target: 27017
        published: 27017
    volumes:
      - testdb:/sth/to/test2

  mongosetup:
    image: mongo:5
    depends_on:
      - db
    restart: "no"
    entrypoint: [ "bash", "-c", "sleep 10 && mongo --host db:27017 --eval 'rs.initiate()'"]

volumes:
  testdb:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /tmp/serverdir

